<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Colección de información geoespacial – Gobernanza ambiental</title>
  <!-- Dependencias: PapaParse (CSV) y Fuse.js (búsqueda difusa) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <style>
    :root{
      --bg: #06150f;          /* fondo muy oscuro verdoso */
      --panel: #0b2018;       /* paneles */
      --muted: #94a3b8;       /* texto atenuado */
      --text: #e6f4ef;        /* texto principal */
      --accent: #0a784f;      /* verde principal */
      --accent-ink:#0a5e41;   /* verde tinta */
      --chip:#103524;         /* chips */
      --border:#153c2a;       /* bordes suaves */
      --warn:#eab308;         /* aviso */
      --err:#ef4444;          /* error */
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      display:flex; flex-direction:column; min-height:100vh;
    }
    header{
      background: linear-gradient(180deg, rgba(10,120,79,0.25), rgba(10,120,79,0));
      border-bottom:1px solid var(--border);
    }
    .wrap{ max-width:1100px; margin:0 auto; padding: 16px; }
    .header-inner{ display:flex; align-items:center; gap:16px; }
    .logo{
      width:44px; height:44px; border-radius:10px; background:#123a29; border:1px solid var(--border); display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    h1{ font-size: clamp(18px, 4vw, 24px); margin:0; font-weight:700; letter-spacing:0.2px; }
    .tagline{ color:var(--muted); font-size:14px; margin-top:4px }

    main{ flex:1; }
    .hero{
      display:grid; place-items:center; padding: 40px 16px 8px;
    }
    .search-card{
      width:min(920px, 100%); background:var(--panel); border:1px solid var(--border); border-radius:18px; box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      padding: 22px; position:relative;
    }
    .search-row{ display:flex; gap:10px; align-items:center; }
    .search-row input[type="search"]{
      flex:1; background:#05120c; border:1px solid var(--border); color:var(--text);
      padding:14px 16px; border-radius:12px; outline:none; font-size:16px;
    }
    .search-row button{
      background:var(--accent); color:#fff; border:none; padding:14px 18px; border-radius:12px; font-weight:600; cursor:pointer;
    }
    .search-row button:disabled{ opacity:0.6; cursor:not-allowed }

    .helper{ color:var(--muted); font-size:13px; margin-top:8px; line-height:1.4 }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px }
    .chip{ background:var(--chip); border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; color:#cfe9df }

    .filters{
      width:min(920px, 100%); margin:12px auto 0; display:grid; grid-template-columns: repeat(12, 1fr); gap:10px; padding: 0 2px;
    }
    .filter{ grid-column: span 6; }
    @media (min-width: 860px){ .filter{ grid-column: span 3; } }
    select, .check{ width:100%; background:var(--panel); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:12px; font-size:14px }
    label.check{ display:flex; align-items:center; gap:10px; padding:11px 12px; cursor:pointer }
    label.check input{ width:18px; height:18px }

    .bar{ width:min(920px, 100%); margin: 14px auto; display:flex; align-items:center; justify-content:space-between; gap:10px; color:var(--muted) }
    .bar .count{ font-size:14px }
    .bar .sort{ display:flex; align-items:center; gap:8px }

    .results{ width:min(920px, 100%); margin: 8px auto 34px; display:grid; gap:10px }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px }
    .card h3{ margin:0 0 6px 0; font-size:18px }
    .meta{ display:flex; flex-wrap:wrap; gap:8px; margin:8px 0 10px 0 }
    .badge{ background:#082319; border:1px solid var(--border); color:#c5efdf; padding:5px 8px; border-radius:999px; font-size:12px }
    .desc{ color:#d9efe7; opacity:0.88; font-size:14px; line-height:1.4; white-space:pre-line }
    .links{ display:flex; flex-wrap:wrap; gap:8px; margin-top:12px }
    .btn{ background:transparent; border:1px solid var(--border); color:#d7eee6; padding:8px 10px; border-radius:10px; font-size:13px; text-decoration:none }
    .btn.primary{ background:var(--accent-ink); color:white; border-color:transparent }
    .btn:hover{ filter:brightness(1.05) }

    .error{ background:#230b0b; border:1px solid #501c1c; color:#ffdddd; padding:12px 14px; border-radius:12px; margin: 10px auto; width:min(920px, 100%) }

    footer{ border-top:1px solid var(--border); color:var(--muted); padding:18px 16px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap header-inner">
      <div class="logo" title="Logo (cárgalo como ./logo.png en el repo)">
        <!-- Espacio para logo institucional -->
        <img id="app-logo" src="./logo.png" alt="Logo" onerror="this.style.display='none'"/>
      </div>
      <div>
        <h1>Colección geoespacial para la gobernanza ambiental</h1>
        <div class="tagline">Observatorio de la Amazonia. Busca, filtra y abre conjuntos de datos relevantes para la gobernanza ambiental.</div>
      </div>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="search-card">
        <div class="search-row">
          <input id="q" type="search" placeholder="Buscar por título, descripción, categoría, origen… p. ej. ‘bosque’ o ‘IGAC’" aria-label="Buscar" />
          <button id="go">Buscar</button>
        </div>
        <div class="helper">
          Puedes reportar novedades y sugerir nuevas variables con esta 
          <a href="https://docs.google.com/spreadsheets/d/1z8filW64tTid-UrH0IxM-YYpqKwVfOizQjpIXrt5f5s/edit?usp=sharing" target="_blank">plantilla</a> 
          , escribiéndonos a selvayconflicto@urosario.edu.co</a>.
          <br>
          Hecho por <a href="https://juancotes.github.io/Sebastian-Cotes-Ontibon/" target="_blank">Sebastián Cotes-Ontibón</a> Agradecemos que nos compartas :) 

        </div>
        <div class="chips" id="chips"></div>
      </div>
    </section>

    <section class="filters">
      <div class="filter">
        <select id="f-categoria">
          <option value="">Categoría — todas</option>
        </select>
      </div>
      <div class="filter">
        <select id="f-origen">
          <option value="">Origen — todos</option>
        </select>
      </div>
      <div class="filter">
        <label class="check"><input type="checkbox" id="f-rest"> Tiene servicio REST</label>
      </div>
      <div class="filter">
        <label class="check"><input type="checkbox" id="f-secundario"> Con acceso secundario</label>
      </div>
      <div class="filter">
        <label class="check"><input type="checkbox" id="f-respaldo"> Con acceso de respaldo</label>
      </div>
    </section>

    <div class="bar">
      <div class="count" id="count">Cargando…</div>
      <div class="sort">
        Ordenar:
        <select id="sort">
          <option value="relevance">Por relevancia</option>
          <option value="titulo">A–Z por título</option>
          <option value="categoria">Por categoría</option>
        </select>
      </div>
    </div>

    <div id="error" class="error" style="display:none">Error al cargar los datos.</div>
    <section id="results" class="results"></section>
  </main>

  <footer>
    <div class="wrap">
    <div style="font-size:13px">
      Hecho por <a href="https://juancotes.github.io/Sebastian-Cotes-Ontibon/" target="_blank">Sebastián Cotes-Ontibón</a>
    </div>
    </div>
  </footer>

<script>
// === Configuración ===
const DATA_URL = 'https://docs.google.com/spreadsheets/d/1Smop4rx0K4pj5sHXD19DE3iqcwTCyqn9ohPxIuJsZ8s/export?format=csv&gid=0';
// Si prefieres un CSV en el mismo repo, sustitúyelo por './datos.csv'.

// === Utilidades ===
const deaccent = (s='') => s.normalize('NFD').replace(/\p{Diacritic}/gu,'');
const by = f => (a,b) => (f(a) > f(b)) ? 1 : (f(a) < f(b) ? -1 : 0);
const debounce = (fn, ms=200) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }};

// Expandir sinónimos sencillos para búsqueda (mejorable con tu dominio)
const THESAURUS = {
  bosque:["forest","bosques"], deforestacion:["deforestation","deforestación"], agua:["hidrografia","río","ríos","hidrica","hídrica"],
  suelo:["edafico","edáfico"], coberturas:["land cover","cobertura"], indice:["índice"], carreteras:["vías","vias"],
};

// Detección de filtros en la query: categoria:, origen:, rest:
function parseQuery(raw){
  const tokens = raw.trim().split(/\s+/);
  const filters = { categoria:"", origen:"", rest:null };
  const restYes = new Set(['si','sí','true','1','yes']);
  const restNo = new Set(['no','false','0']);
  const remain = [];
  for(const t of tokens){
    const [k,v] = t.split(":");
    if(!v){ remain.push(t); continue; }
    const key = deaccent(k.toLowerCase());
    const val = v.toLowerCase();
    if(key === 'categoria' || key==='cat') filters.categoria = val;
    else if(key === 'origen' || key==='org') filters.origen = val;
    else if(key === 'rest') {
      if(restYes.has(val)) filters.rest = true; else if(restNo.has(val)) filters.rest = false;
    } else remain.push(t);
  }
  return { text: remain.join(' '), filters };
}

function extractYear(str=''){
  const m = String(str).match(/\b(19\d{2}|20\d{2})\b/);
  return m ? m[1] : '';
}

function normalizeRecord(rec){
  // Normaliza llaves y añade campos derivados
  const out = {};
  for (const [k,vRaw] of Object.entries(rec)){
    const key = deaccent(String(k).trim().toLowerCase())
      .replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'');
    const v = (vRaw==null) ? '' : String(vRaw).trim();
    out[key] = v;
  }
  // Aliases esperados según tu hoja ejemplo
  out.titulo = out.titulo || out.title || '';
  out.descripcion = out.descripcion || out.description || '';
  out.categoria = out.categoria || out.categoria_ || out['categor_a'] || '';
  out.origen = out.origen || out.fuente || '';
  out.acceso = out.acceso || out.url || '';
  out.acceso_secundario = out['acceso_secundario'] || '';
  out.acceso_respaldo = out['acceso_de_respaldo'] || out.respaldo || '';
  out.rest = out.rest || '';
  out.anio = extractYear(out.titulo) || extractYear(out.descripcion);
  out._concat = [out.titulo, out.descripcion, out.categoria, out.origen].filter(Boolean).join(' \n ');
  return out;
}

function uniqueSorted(arr){ return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'})); }

// === Estado ===
let RAW = [];      // registros normalizados
let FUSE = null;   // índice de búsqueda
let LAST_RESULTS = [];

// === Carga de datos ===
function loadCSV(){
  return new Promise((resolve, reject)=>{
    Papa.parse(DATA_URL, {
      download:true,
      header:true,
      skipEmptyLines:true,
      complete: (res)=>{
        try{
          RAW = res.data.map(normalizeRecord);
          buildFacets();
          buildFuse();
          resolve(RAW);
        }catch(e){ reject(e); }
      },
      error: (err)=> reject(err)
    });
  });
}

function buildFuse(){
  const keys = [
    {name:'titulo', weight:0.5},
    {name:'descripcion', weight:0.25},
    {name:'categoria', weight:0.15},
    {name:'origen', weight:0.10},
  ];
  FUSE = new Fuse(RAW, {
    includeScore:true,
    includeMatches:false,
    ignoreLocation:true,
    threshold:0.34,
    useExtendedSearch:true,
    keys
  });
}

function buildFacets(){
  const cats = uniqueSorted(RAW.map(r=>r.categoria));
  const orgs = uniqueSorted(RAW.map(r=>r.origen));
  const selCat = document.getElementById('f-categoria');
  const selOrg = document.getElementById('f-origen');
  for(const v of cats){ const o=document.createElement('option'); o.value=v; o.textContent=v; selCat.appendChild(o); }
  for(const v of orgs){ const o=document.createElement('option'); o.value=v; o.textContent=v; selOrg.appendChild(o); }

  // Chips rápidas (las 6 primeras combinando categorías y orígenes más frecuentes)
  const chips = document.getElementById('chips');
  chips.innerHTML='';
  const freq = (list)=> Object.entries(list.reduce((acc,x)=>{acc[x]=(acc[x]||0)+1; return acc;},{}))
                      .sort((a,b)=>b[1]-a[1]).map(([k])=>k).slice(0,3);
  const topCats = freq(RAW.map(r=>r.categoria).filter(Boolean));
  const topOrgs = freq(RAW.map(r=>r.origen).filter(Boolean));
  for(const c of topCats){ const s=document.createElement('span'); s.className='chip'; s.textContent=c; s.onclick=()=>applyQuickFilter('categoria',c); chips.appendChild(s);}
  for(const o of topOrgs){ const s=document.createElement('span'); s.className='chip'; s.textContent=o; s.onclick=()=>applyQuickFilter('origen',o); chips.appendChild(s);}
}

function applyQuickFilter(type, val){
  document.getElementById(type==='categoria'?'f-categoria':'f-origen').value = val;
  runSearch();
}

// Expande términos con sinónimos básicos
function expandTerms(text){
  const words = text.split(/\s+/).map(w=>deaccent(w.toLowerCase()));
  const extra = [];
  for(const w of words){ if(THESAURUS[w]) extra.push(...THESAURUS[w]); }
  return words.concat(extra).join(' ');
}

function filterAndRank(query, facetFilters){
  let base = RAW;
  // Facetas
  if(facetFilters.categoria){
    const q = deaccent(facetFilters.categoria.toLowerCase());
    base = base.filter(r=>deaccent(r.categoria.toLowerCase()).includes(q));
  }
  if(facetFilters.origen){
    const q = deaccent(facetFilters.origen.toLowerCase());
    base = base.filter(r=>deaccent(r.origen.toLowerCase()).includes(q));
  }
  if(facetFilters.rest === true){ base = base.filter(r => r.rest); }
  if(facetFilters.rest === false){ base = base.filter(r => !r.rest); }
  if(document.getElementById('f-secundario').checked){ base = base.filter(r => r.acceso_secundario); }
  if(document.getElementById('f-respaldo').checked){ base = base.filter(r => r.acceso_respaldo); }

  // Búsqueda difusa
  let ranked = base;
  if(query){
    const expanded = expandTerms(query);
    // Usamos patrón extendido de Fuse con OR entre palabras
    const pattern = expanded.split(/\s+/).filter(Boolean).map(w=>`'${w}`).join(' | ');
    ranked = FUSE.search(pattern).map(x=>x.item).filter(x=> base.includes(x));
  }
  return ranked;
}

function sortResults(list){
  const mode = document.getElementById('sort').value;
  if(mode==='titulo') return list.slice().sort(by(x=>deaccent(x.titulo.toLowerCase())));
  if(mode==='categoria') return list.slice().sort(by(x=>deaccent(x.categoria.toLowerCase()+"|"+x.titulo.toLowerCase())));
  return list; // relevancia = ya vienen ordenados
}

function render(list){
  const wrap = document.getElementById('results');
  wrap.innerHTML='';
  const count = document.getElementById('count');
  count.textContent = `${list.length} ${list.length===1?'resultado':'resultados'}`;
  for(const r of list){
    const card = document.createElement('article');
    card.className = 'card';
    const h = document.createElement('h3'); h.textContent = r.titulo || 'Sin título';
    const meta = document.createElement('div'); meta.className='meta';
    if(r.categoria){ const b=document.createElement('span'); b.className='badge'; b.textContent=r.categoria; meta.appendChild(b); }
    if(r.origen){ const b=document.createElement('span'); b.className='badge'; b.textContent=r.origen; meta.appendChild(b); }
    if(r.anio){ const b=document.createElement('span'); b.className='badge'; b.textContent=`Año ${r.anio}`; meta.appendChild(b); }

    const p = document.createElement('div'); p.className='desc'; p.textContent = r.descripcion || '';

    const links = document.createElement('div'); links.className='links';
    if(r.acceso){ links.appendChild(linkBtn(r.acceso, 'Abrir')) }
    if(r.rest){ links.appendChild(linkBtn(r.rest, 'REST', true)) }
    if(r.acceso_secundario){ links.appendChild(linkBtn(r.acceso_secundario, 'Secundario')) }
    if(r.acceso_respaldo){ links.appendChild(linkBtn(r.acceso_respaldo, 'Respaldo')) }
    links.appendChild(copyBtn(r.acceso || r.rest || r.acceso_secundario || r.acceso_respaldo || ''));

    card.append(h, meta, p, links);
    wrap.appendChild(card);
  }
}

function linkBtn(href, label, primary=false){
  const a = document.createElement('a');
  a.href = href; a.target = '_blank'; a.rel='noopener noreferrer';
  a.className = 'btn' + (primary ? ' primary' : '');
  a.textContent = label;
  return a;
}

function copyBtn(text){
  const b = document.createElement('button');
  b.className='btn'; b.textContent='Copiar enlace';
  b.onclick = async ()=>{
    try{ await navigator.clipboard.writeText(text); b.textContent='¡Copiado!'; setTimeout(()=>b.textContent='Copiar enlace', 1200);}catch(e){ b.textContent='Error'; setTimeout(()=>b.textContent='Copiar enlace', 1200); }
  };
  return b;
}

function runSearch(){
  const raw = document.getElementById('q').value;
  const { text, filters } = parseQuery(raw);
  // sumar facetas de UI
  const uiCat = document.getElementById('f-categoria').value;
  const uiOrg = document.getElementById('f-origen').value;
  const uiRest = document.getElementById('f-rest').checked ? true : (document.getElementById('f-rest').indeterminate ? null : false);
  const merged = {
    categoria: uiCat || filters.categoria,
    origen: uiOrg || filters.origen,
    rest: (filters.rest!==null) ? filters.rest : (document.getElementById('f-rest').checked ? true : null)
  };
  let list = filterAndRank(text, merged);
  list = sortResults(list);
  LAST_RESULTS = list;
  render(list);
}

// Inicialización
(async function init(){
  try{
    document.getElementById('count').textContent = 'Cargando…';
    await loadCSV();
    document.getElementById('error').style.display='none';
  }catch(err){
    console.error(err);
    document.getElementById('error').style.display='block';
  }
  // Eventos
  const go = document.getElementById('go');
  const q = document.getElementById('q');
  const fcat = document.getElementById('f-categoria');
  const forg = document.getElementById('f-origen');
  const frest = document.getElementById('f-rest');
  const fsec = document.getElementById('f-secundario');
  const fres = document.getElementById('f-respaldo');
  const sort = document.getElementById('sort');

  go.onclick = runSearch;
  q.addEventListener('input', debounce(runSearch, 200));
  fcat.onchange = runSearch; forg.onchange = runSearch; sort.onchange = runSearch;
  frest.onchange = runSearch; fsec.onchange = runSearch; fres.onchange = runSearch;

  runSearch();
})();
</script>
</body>
</html>
